- name: Adding required dracut modules
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/dracut.conf.d/iscsi-boot.conf
    line: add_dracutmodules+="network iscsi"
    create: yes
  notify: Rebuild dracut image

- name: Dumping current partitions
  ansible.builtin.debug:
    var: ansible_devices
    verbosity: 3

- name: Creating EFI system partition
  become: yes
  community.general.parted:
    device: /dev/sda
    number: 2
    part_start: -256MiB
    state: present
    unit: MiB
  notify: Rebuild GRUB configuration

- name: Changing EFI system partition type
  become: yes
  ansible.builtin.command: sfdisk -c /dev/sda 2 ef
  notify: Rebuild GRUB configuration

- name: Creating FAT filesystem on the ESP
  become: yes
  community.general.filesystem:
    device: /dev/sda2
    fstype: vfat
    opts: -F 32
    state: present
  notify: Rebuild GRUB configuration

- name: Mounting EFI system partition
  become: yes
  ansible.posix.mount:
    path: /boot/efi/
    src: /dev/sda2
    state: mounted
    fstype: fat32
  notify: Rebuild GRUB configuration

- name: Installing GRUB EFI package
  become: yes
  ansible.builtin.yum:
    name:
      - grub2-efi
      - shim
  notify: Rebuild GRUB configuration

- name: Configuring GRUB kernel command line
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    line: GRUB_CMDLINE_LINUX_DEFAULT="$GRUB_CMDLINE_LINUX_DEFAULT rd.iscsi.firmware=1"
  notify: Rebuild GRUB configuration
